name: Build and Deploy Calibre-Web

on:
  push:
    branches:
      - master
    paths:
      - "cps/**"
      - "cps.py"
      - "requirements.txt"
      - "pyproject.toml"
      - "Dockerfile"
      - ".dockerignore"
      - "cps/templates/**"
      - "cps/static/**"
      - ".github/workflows/docker-publish.yml"
  pull_request:
    branches:
      - master
    paths:
      - "cps/**"
      - "cps.py"
      - "requirements.txt"
      - "pyproject.toml"
      - "Dockerfile"
      - ".dockerignore"
      - "cps/templates/**"
      - "cps/static/**"
      - ".github/workflows/docker-publish.yml"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=latest
            type=sha

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: ${{ github.event_name == 'push' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: ${{ github.event_name == 'push' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare SSH key
        env:
          VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$VPS_SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$VPS_HOST" >> ~/.ssh/known_hosts

      - name: Deploy over SSH
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
        run: |
          set -o pipefail
          PORT="${VPS_PORT:-22}"
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=yes -p "$PORT" "$VPS_USER@$VPS_HOST" \
            'set -e; cd /root/n8n; docker compose pull calibre-web; docker compose up -d calibre-web' \
            2>&1 | tee deploy.log

      - name: Notify Feishu on deploy success
        if: success()
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          SITE_URL: ${{ vars.SITE_URL }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          REPO: ${{ github.repository }}
        run: |
          if [ -z "$FEISHU_WEBHOOK" ]; then
            echo "FEISHU_WEBHOOK not set, skip notification."
            exit 0
          fi
          python - <<'PY' > payload.json
          import json
          import os
          import subprocess
          def git(cmd):
              return subprocess.check_output(cmd, text=True).strip()
          commit_sha = git(["git", "rev-parse", "--short", "HEAD"])
          commit_msg = subprocess.check_output(["git", "log", "-1", "--pretty=%B"], text=True).strip()
          repo = os.environ.get("REPO", "")
          run_url = os.environ.get("RUN_URL", "")
          site_url = os.environ.get("SITE_URL", "未配置")
          text = "\n".join([
              "✅ 部署成功",
              f"仓库: {repo}",
              f"提交: {commit_sha}",
              "提交信息:",
              commit_msg or "(空)",
              f"站点: {site_url}",
              f"CI: {run_url}",
          ])
          print(json.dumps({"msg_type": "text", "content": {"text": text}}, ensure_ascii=False))
          PY
          curl -sS -X POST -H "Content-Type: application/json" -d @payload.json "$FEISHU_WEBHOOK"

      - name: Notify Feishu on deploy failure
        if: failure()
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          REPO: ${{ github.repository }}
        run: |
          if [ -z "$FEISHU_WEBHOOK" ]; then
            echo "FEISHU_WEBHOOK not set, skip notification."
            exit 0
          fi
          LOG="$(tail -n 80 deploy.log 2>/dev/null || true)"
          export LOG
          python - <<'PY' > payload.json
          import json
          import os
          import subprocess
          def git(cmd):
              return subprocess.check_output(cmd, text=True).strip()
          commit_sha = git(["git", "rev-parse", "--short", "HEAD"])
          commit_msg = subprocess.check_output(["git", "log", "-1", "--pretty=%B"], text=True).strip()
          repo = os.environ.get("REPO", "")
          run_url = os.environ.get("RUN_URL", "")
          log = os.environ.get("LOG", "")
          text = "\n".join([
              "❌ 部署失败",
              f"仓库: {repo}",
              f"提交: {commit_sha}",
              "提交信息:",
              commit_msg or "(空)",
              "日志:",
              log or "(无)",
              f"CI: {run_url}",
          ])
          print(json.dumps({"msg_type": "text", "content": {"text": text}}, ensure_ascii=False))
          PY
          curl -sS -X POST -H "Content-Type: application/json" -d @payload.json "$FEISHU_WEBHOOK"
